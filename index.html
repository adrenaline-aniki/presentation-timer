<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>発表タイマー（拡張版）</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  padding: 20px;
  transition: background-color 0.3s;
}

.timer {
  font-size: 60px;
  margin: 20px 0;
}

.overTime {
  color: red;
}

input {
  width: 60px;
  padding: 5px;
  margin: 5px;
}

button {
  padding: 6px 12px;
  margin: 5px;
  cursor: pointer;
}

table {
  margin: 20px auto;
  border-collapse: collapse;
  width: 95%;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
}

th {
  background: #eee;
  cursor: pointer;
}

.fileBtn {
  display: inline-block;
  padding: 6px 12px;
  background: #ddd;
  cursor: pointer;
}
</style>
</head>
<body>

<h1>発表タイマー</h1>

出席番号
<input type="number" id="studentNumber">

<br><br>

発表時間
<input type="number" id="totalMin" value="2">分
<input type="number" id="totalSec" value="0">秒

<br><br>

ベル① 残り
<input type="number" id="bell1Min" value="1">分
<input type="number" id="bell1Sec" value="0">秒

ベル② 残り
<input type="number" id="bell2Min" value="0">分
<input type="number" id="bell2Sec" value="30">秒

ベル③ 残り
<input type="number" id="bell3Min" value="0">分
<input type="number" id="bell3Sec" value="0">秒

<br><br>

<button onclick="startTimer()">開始</button>
<button onclick="stopTimer()">終了</button>
<button onclick="exportCSV()">CSV書き出し</button>

<label class="fileBtn">
CSV読込
<input type="file" onchange="loadCSV(event)" hidden>
</label>

<div class="timer" id="display">02:00</div>

<audio id="bell" src="bell.mp3"></audio>

<h2>記録</h2>

<table>
<thead>
<tr>
<th onclick="sortTable()">出席番号 ▲▼</th>
<th>発表時間</th>
<th>オーバー</th>
<th>メモ</th>
<th>削除</th>
</tr>
</thead>
<tbody id="records"></tbody>
</table>

<script>

let interval;
let endTime;
let totalMsGlobal;
let records = JSON.parse(localStorage.getItem("records")) || [];
let sortAsc = true;

function startTimer() {

  const student = document.getElementById("studentNumber").value;
  if (!student) {
    alert("出席番号を入力してください");
    return;
  }

  const totalMin = Number(document.getElementById("totalMin").value);
  const totalSec = Number(document.getElementById("totalSec").value);
  totalMsGlobal = (totalMin * 60 + totalSec) * 1000;

  const bell1 = getMs("bell1Min", "bell1Sec");
  const bell2 = getMs("bell2Min", "bell2Sec");
  const bell3 = getMs("bell3Min", "bell3Sec");

  let bell1Played=false, bell2Played=false, bell3Played=false;

  endTime = Date.now() + totalMsGlobal;

  let previousRemaining = totalMsGlobal;

  clearInterval(interval);

  interval = setInterval(() => {

    const now = Date.now();
    const remaining = endTime - now;
    const elapsed = now - (endTime - totalMsGlobal);

    // ===== 表示処理 =====
    let displayMin, displaySec;

    if (remaining >= 0) {
      const totalSeconds = Math.floor(remaining / 1000);
      displayMin = Math.floor(totalSeconds / 60);
      displaySec = totalSeconds % 60;
      document.getElementById("display").classList.remove("overTime");
    } else {
      const overSeconds = Math.floor(Math.abs(remaining) / 1000);
      displayMin = Math.floor(overSeconds / 60);
      displaySec = overSeconds % 60;
      document.getElementById("display").classList.add("overTime");
    }

    document.getElementById("display").innerText =
      `${String(displayMin).padStart(2,'0')}:${String(displaySec).padStart(2,'0')}`;

    // ===== ベル判定（瞬間検出）=====
    if (!bell1Played && previousRemaining > bell1 && remaining <= bell1) {
      playBell(1);
      bell1Played = true;
    }

    if (!bell2Played && previousRemaining > bell2 && remaining <= bell2) {
      playBell(2);
      bell2Played = true;
    }

    if (!bell3Played && previousRemaining > bell3 && remaining <= bell3) {
      playBell(3);
      bell3Played = true;
    }

    previousRemaining = remaining;

  }, 200);
}

function stopTimer() {

  clearInterval(interval);

  const actualElapsed = Date.now() - (endTime - totalMsGlobal);

  const actualMin = Math.floor(actualElapsed / 60000);
  const actualSec = Math.floor((actualElapsed % 60000) / 1000);

  const overMs = actualElapsed - totalMsGlobal;

  let overText = "0分0秒";
  if (overMs > 0) {
    const overMin = Math.floor(overMs / 60000);
    const overSec = Math.floor((overMs % 60000) / 1000);
    overText = `${overMin}分${overSec}秒`;
  }

  const student = document.getElementById("studentNumber").value;

  records.push({
    number:Number(student),
    actual:`${actualMin}分${actualSec}秒`,
    over:overText,
    memo:""
  });

  localStorage.setItem("records", JSON.stringify(records));
  renderTable();
}

function getMs(minId,secId){
  return (Number(document.getElementById(minId).value)*60 +
          Number(document.getElementById(secId).value))*1000;
}

function playBell(times){

  const bell = document.getElementById("bell");
  let count = 0;

  function playOnce(){

    bell.currentTime = 0;
    bell.play().catch(()=>{});

    count++;

    if(count < times){
      // 最後以外は短く切る
      setTimeout(()=>{
        bell.pause();
        bell.currentTime = 0;
        playOnce();
      }, 200);  // 0.45秒で次
    }

    // 最後は止めない（余韻あり）
  }

  playOnce();
}


function renderTable(){
  const tbody=document.getElementById("records");
  tbody.innerHTML="";
  records.forEach((r,index)=>{
    tbody.innerHTML+=`
      <tr>
        <td>${r.number}</td>
        <td>${r.actual}</td>
        <td>${r.over}</td>
        <td contenteditable onblur="updateMemo(${index},this.innerText)">
        ${r.memo||""}
        </td>
        <td><button onclick="deleteRecord(${index})">削除</button></td>
      </tr>
    `;
  });
}

function deleteRecord(index){
  records.splice(index,1);
  localStorage.setItem("records",JSON.stringify(records));
  renderTable();
}

function updateMemo(index,value){
  records[index].memo=value;
  localStorage.setItem("records",JSON.stringify(records));
}

function sortTable(){
  records.sort((a,b)=>sortAsc?a.number-b.number:b.number-a.number);
  sortAsc=!sortAsc;
  renderTable();
}

function exportCSV(){
  let csv="出席番号,実際時間,オーバー,メモ\n";
  records.forEach(r=>{
    csv+=`${r.number},${r.actual},${r.over},${r.memo}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="records.csv";
  link.click();
}

function loadCSV(event){
  const file=event.target.files[0];
  const reader=new FileReader();

  reader.onload=function(e){
    const lines=e.target.result.split("\n");
    records=[];
    lines.slice(1).forEach(line=>{
      const cols=line.split(",");
      if(cols[0]){
        records.push({
          number:Number(cols[0]),
          actual:cols[1]||"",
          over:cols[2]||"",
          memo:cols[3]||""
        });
      }
    });
    localStorage.setItem("records",JSON.stringify(records));
    renderTable();
  };

  reader.readAsText(file);
}

renderTable();

</script>
</body>
</html>

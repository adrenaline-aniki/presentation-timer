<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç™ºè¡¨ã‚¿ã‚¤ãƒãƒ¼PRO</title>
<style>
body{
  font-family:sans-serif;
  text-align:center;
  background:#f4f6f8;
}
.timer{
  font-size:80px;
  margin:20px;
}
input,button{
  padding:6px;
  margin:4px;
}
table{
  border-collapse:collapse;
  width:100%;
}
th,td{
  border:1px solid #ccc;
  padding:6px 10px;
}
.star{
  font-size:22px;
  cursor:pointer;
  color:#ccc;
}
.active{ color:gold; }
.currentRow{ background:#fff3cd; }

.tableContainer{
  max-height:300px;
  overflow-y:auto;
  margin:20px auto;
  width:95%;
  background:white;
  border:1px solid #ccc;
}

.signature{
  position:fixed;
  bottom:10px;
  right:15px;
  font-size:12px;
  color:rgba(0,0,0,0.25);
}
</style>
</head>
<body>

<h2>ç™ºè¡¨ã‚¿ã‚¤ãƒãƒ¼ PRO</h2>

<div>
å‡ºå¸­ç•ªå·ï¼š
<input type="number" id="studentNumber" min="1" style="width:60px">
</div>

<div>
è¨­å®šæ™‚é–“ï¼š
<input type="number" id="setMin" value="2" style="width:60px"> åˆ†
<input type="number" id="setSec" value="0" style="width:60px"> ç§’
</div>

<!-- â–¼â–¼ ãƒ™ãƒ«å¾©æ´» â–¼â–¼ -->

<div>
ãƒ™ãƒ«ï¼‘ï¼ˆæ®‹ã‚Šï¼‰ï¼š
<input type="number" id="bell1Min" value="1" style="width:60px"> åˆ†
<input type="number" id="bell1Sec" value="0" style="width:60px"> ç§’
å›æ•°ï¼š
<select id="bell1Count">
<option value="0">0</option>
<option value="1" selected>1</option>
<option value="2">2</option>
<option value="3">3</option>
</select>
</div>

<div>
ãƒ™ãƒ«ï¼’ï¼ˆæ®‹ã‚Šï¼‰ï¼š
<input type="number" id="bell2Min" value="0" style="width:60px"> åˆ†
<input type="number" id="bell2Sec" value="30" style="width:60px"> ç§’
å›æ•°ï¼š
<select id="bell2Count">
<option value="0">0</option>
<option value="1">1</option>
<option value="2" selected>2</option>
<option value="3">3</option>
</select>
</div>

<div>
ãƒ™ãƒ«ï¼“ï¼ˆæ®‹ã‚Šï¼‰ï¼š
<input type="number" id="bell3Min" value="0" style="width:60px"> åˆ†
<input type="number" id="bell3Sec" value="0" style="width:60px"> ç§’
å›æ•°ï¼š
<select id="bell3Count">
<option value="0">0</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3" selected>3</option>
</select>
</div>

<!-- â–²â–² ãƒ™ãƒ«å¾©æ´» â–²â–² -->

<div class="timer" id="timer">00:00</div>

<button onclick="startTimer()">é–‹å§‹</button>
<button onclick="stopTimer()">çµ‚äº†</button>

<br><br>

CSVåï¼š
<input type="text" id="csvName" placeholder="ã‚¯ãƒ©ã‚¹åãªã©">
<button onclick="exportCSV()">CSVå‡ºåŠ›</button>
<input type="file" accept=".csv" onchange="importCSV(event)">

<div class="tableContainer">
<table>
<thead>
<tr>
<th>ç•ªå·</th>
<th>ç™ºè¡¨æ™‚é–“</th>
<th>ã‚ªãƒ¼ãƒãƒ¼</th>
<th>å…·ä½“æ€§</th>
<th>ç‹¬è‡ªæ€§</th>
<th>æŠ€è¡“åŠ›</th>
<th>ãƒ¡ãƒ¢</th>
<th>å‰Šé™¤</th>
</tr>
</thead>
<tbody id="recordTable"></tbody>
</table>
</div>

<script>
let interval;
let endTime;
let totalMsGlobal;
let bellSettings=[];
let records=JSON.parse(localStorage.getItem("records"))||[];
let currentIndex=null;

function playBell(times){
  const audio=new Audio("https://actions.google.com/sounds/v1/alarms/bell_ring.ogg");
  for(let i=0;i<times;i++){
    setTimeout(()=>{
      audio.currentTime=0;
      audio.play();
    },i*150);
  }
}

function getMs(minId,secId){
  const m=Number(document.getElementById(minId).value)||0;
  const s=Number(document.getElementById(secId).value)||0;
  return (m*60+s)*1000;
}

function startTimer(){
  const student=document.getElementById("studentNumber").value;
  if(!student){ alert("å‡ºå¸­ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  records.push({
    number:Number(student),
    actual:"è¨ˆæ¸¬ä¸­",
    over:"-",
    memo:"",
    specific:0,
    originality:0,
    skill:0
  });

  currentIndex=records.length-1;
  localStorage.setItem("records",JSON.stringify(records));
  renderTable();

  totalMsGlobal=getMs("setMin","setSec");
  endTime=Date.now()+totalMsGlobal;

  bellSettings=[
    {time:getMs("bell1Min","bell1Sec"),count:Number(document.getElementById("bell1Count").value)},
    {time:getMs("bell2Min","bell2Sec"),count:Number(document.getElementById("bell2Count").value)},
    {time:getMs("bell3Min","bell3Sec"),count:Number(document.getElementById("bell3Count").value)}
  ];

interval=setInterval(()=>{
  const now=Date.now();
  const remaining=endTime-now;
  const displayMs=remaining>=0?remaining:Math.abs(remaining);

  const min=Math.floor(displayMs/60000);
  const sec=Math.floor((displayMs%60000)/1000);

  document.getElementById("timer").textContent=
    (remaining>=0?"":"+")+
    String(min).padStart(2,"0")+":"+String(sec).padStart(2,"0");

  // ğŸ”” ãƒ™ãƒ«åˆ¤å®šå¾©æ´»
  bellSettings.forEach(b=>{
    if(
      b.count>0 &&
      remaining<=b.time &&
      remaining> b.time-300
    ){
      playBell(b.count);
      b.count=0; // ä¸€å›ã ã‘é³´ã‚‰ã™
    }
  });

},200);

function stopTimer(){
  clearInterval(interval);
  if(currentIndex===null) return;

  const actualElapsed=Date.now()-(endTime-totalMsGlobal);
  const actualMin=Math.floor(actualElapsed/60000);
  const actualSec=Math.floor((actualElapsed%60000)/1000);

  const overMs=actualElapsed-totalMsGlobal;
  let overText="0åˆ†0ç§’";
  if(overMs>0){
    const om=Math.floor(overMs/60000);
    const os=Math.floor((overMs%60000)/1000);
    overText=`${om}åˆ†${os}ç§’`;
  }

  records[currentIndex].actual=`${actualMin}åˆ†${actualSec}ç§’`;
  records[currentIndex].over=overText;

  localStorage.setItem("records",JSON.stringify(records));
  renderTable();
  currentIndex=null;
}

function renderStars(value,index,key){
  let html="";
  for(let i=1;i<=3;i++){
    html+=`<span class="star ${i<=value?"active":""}"
    onclick="setRating(${index},'${key}',${i})">â˜…</span>`;
  }
  return html;
}

function setRating(index,key,value){
  records[index][key]=value;
  localStorage.setItem("records",JSON.stringify(records));
  renderTable();
}

function updateMemo(index,text){
  records[index].memo=text;
  localStorage.setItem("records",JSON.stringify(records));
}

function updateNumber(index,value){
  records[index].number=Number(value);
  localStorage.setItem("records",JSON.stringify(records));
}

function renderTable(){
  const table=document.getElementById("recordTable");
  table.innerHTML="";
  records.forEach((r,i)=>{
    const row=document.createElement("tr");
    if(i===currentIndex) row.classList.add("currentRow");
    row.innerHTML=`
    <td><input type="number" value="${r.number}"
      style="width:60px"
      onchange="updateNumber(${i},this.value)"></td>
    <td>${r.actual}</td>
    <td>${r.over}</td>
    <td>${renderStars(r.specific,i,"specific")}</td>
    <td>${renderStars(r.originality,i,"originality")}</td>
    <td>${renderStars(r.skill,i,"skill")}</td>
    <td>
      <input value="${r.memo}" 
        oninput="updateMemo(${i},this.value)">
    </td>
    <td>
      <button onclick="deleteRecord(${i})">å‰Šé™¤</button>
    </td>
    `;
    table.appendChild(row);
  });
}

function deleteRecord(index){
  if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  records.splice(index,1);
  localStorage.setItem("records",JSON.stringify(records));
  renderTable();
}

function exportCSV(){
  let csv="ç•ªå·,å®Ÿéš›æ™‚é–“,ã‚ªãƒ¼ãƒãƒ¼,å…·ä½“æ€§,ç‹¬è‡ªæ€§,æŠ€è¡“åŠ›,ãƒ¡ãƒ¢\n";
  records.forEach(r=>{
    csv+=`${r.number},${r.actual},${r.over},${r.specific},${r.originality},${r.skill},"${r.memo}"\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");

  const name=document.getElementById("csvName").value.trim();
  a.download=(name?name:"presentation_records")+".csv";

  a.href=url;
  a.click();
  URL.revokeObjectURL(url);
}

function importCSV(event){
  const file=event.target.files[0];
  if(!file) return;

  const reader=new FileReader();
  reader.onload=function(e){
    const lines=e.target.result.split("\n");
    lines.shift();
    records=[];
    lines.forEach(line=>{
      if(!line.trim()) return;
      const cols=line.split(",");
      records.push({
        number:Number(cols[0]),
        actual:cols[1],
        over:cols[2],
        specific:Number(cols[3]),
        originality:Number(cols[4]),
        skill:Number(cols[5]),
        memo:cols[6]?.replace(/"/g,"")||""
      });
    });
    localStorage.setItem("records",JSON.stringify(records));
    renderTable();
  };
  reader.readAsText(file);
}

renderTable();
</script>

<div class="signature">Â©ï¸2026 h.kikuchi</div>
</body>
</html>
